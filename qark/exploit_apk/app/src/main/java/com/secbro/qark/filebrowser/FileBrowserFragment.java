/*
 * Copyright 2015 LinkedIn Corp. Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 */

 package com.secbro.qark.filebrowser;

 import android.content.Intent;
 import android.content.res.Configuration;
 import android.graphics.Color;
 import android.os.Bundle;
 import android.os.Environment;
 import android.os.StatFs;
 import android.util.Log;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.*;
 
 import androidx.annotation.Nullable;
 import androidx.fragment.app.Fragment; // Migrated to AndroidX
 
 import com.secbro.qark.R;
 
 import java.io.File;
 import java.io.FilenameFilter;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Comparator;
 import java.util.List;
 
 public class FileBrowserFragment extends Fragment {
 
     private final int REQUEST_CODE_PICK_DIR = 1;
     private final int REQUEST_CODE_PICK_FILE = 2;
 
     public static final String INTENT_ACTION_SELECT_DIR = "com.secbro.qark.SELECT_DIRECTORY_ACTION";
     public static final String INTENT_ACTION_SELECT_FILE = "com.secbro.qark.SELECT_FILE_ACTION";
 
     public static final String startDirectoryParameter = "com.secbro.qark.directoryPath";
     public static final String returnDirectoryParameter = "com.secbro.qark.directoryPathRet";
     public static final String returnFileParameter = "com.secbro.qark.filePathRet";
     public static final String showCannotReadParameter = "com.secbro.qark.showCannotRead";
     public static final String filterExtension = "com.secbro.qark.filterExtension";
 
     private final ArrayList<String> pathDirsList = new ArrayList<>();
     private static final String LOGTAG = "F_PATH";
 
     private List<Item> fileList = new ArrayList<>();
     private File path = null;
     private String chosenFile;
     private ArrayAdapter<Item> adapter;
 
     private boolean showHiddenFilesAndDirs = true;
     private boolean directoryShownIsEmpty = false;
     private String filterFileExtension = null;
     private static int currentAction = -1;
     private static final int SELECT_DIRECTORY = 1;
     private static final int SELECT_FILE = 2;
 
     public static FileBrowserFragment newInstance() {
         return new FileBrowserFragment();
     }
 
     @Override
     public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
         super.onCreateView(inflater, container, savedInstanceState);
         return inflater.inflate(R.layout.fragment_file_browser, container, false);
     }
 
     @Override
     public void onActivityCreated(@Nullable Bundle savedInstanceState) {
         super.onActivityCreated(savedInstanceState);
 
         setInitialDirectory();
         parseDirectoryPath();
         loadFileList();
         createFileListAdapter();
         initializeButtons();
         initializeFileListView();
         updateCurrentDirectoryTextView();
         Log.d(LOGTAG, "Current Path: " + path.getAbsolutePath());
     }
 
     private void setInitialDirectory() {
         Intent intent = requireActivity().getIntent();
         String requestedStartDir = intent.getStringExtra(startDirectoryParameter);
 
         if (requestedStartDir != null && !requestedStartDir.isEmpty()) {
             File tempFile = new File(requestedStartDir);
             if (tempFile.isDirectory()) {
                 path = tempFile;
             }
         }
 
         if (path == null) {
             path = Environment.getExternalStorageDirectory().isDirectory() &&
                     Environment.getExternalStorageDirectory().canRead() ?
                     Environment.getExternalStorageDirectory() : new File("/");
         }
     }
 
     private void parseDirectoryPath() {
         pathDirsList.clear();
         String[] parts = path.getAbsolutePath().split("/");
         Collections.addAll(pathDirsList, parts);
     }
 
     private void initializeButtons() {
         Button upDirButton = requireView().findViewById(R.id.upDirectoryButton);
         upDirButton.setOnClickListener(v -> {
             Log.d(LOGTAG, "Up Directory Button Clicked");
             loadDirectoryUp();
             loadFileList();
             adapter.notifyDataSetChanged();
             updateCurrentDirectoryTextView();
         });
 
         Button selectFolderButton = requireView().findViewById(R.id.selectCurrentDirectoryButton);
         if (currentAction == SELECT_DIRECTORY) {
             selectFolderButton.setOnClickListener(v -> {
                 Log.d(LOGTAG, "Select Folder Button Clicked");
                 returnDirectoryFinishActivity();
             });
         } else {
             selectFolderButton.setVisibility(View.GONE);
         }
     }
 
     private void loadDirectoryUp() {
         if (!pathDirsList.isEmpty()) {
             String removedDir = pathDirsList.remove(pathDirsList.size() - 1);
             path = new File(path.toString().replace("/" + removedDir, ""));
         }
         fileList.clear();
     }
 
     private void updateCurrentDirectoryTextView() {
         String curDirString = String.join("/", pathDirsList) + "/";
         long freeSpace = getFreeSpace(curDirString);
         String formattedSpaceString = formatBytes(freeSpace);
 
         if (freeSpace == 0 && !new File(curDirString).canWrite()) {
             formattedSpaceString = "NON Writable";
         }
 
         requireView().findViewById(R.id.upDirectoryButton).setEnabled(!pathDirsList.isEmpty());
         ((Button) requireView().findViewById(R.id.selectCurrentDirectoryButton)).setText("Select\n[" + formattedSpaceString + "]");
         ((TextView) requireView().findViewById(R.id.currentDirectoryTextView)).setText("Current directory: " + curDirString);
     }
 
     public static long getFreeSpace(String path) {
         StatFs stat = new StatFs(path);
         return (long) stat.getAvailableBlocksLong() * stat.getBlockSizeLong();
     }
 
     public static String formatBytes(long bytes) {
         if (bytes >= 1073741824) return (bytes / 1073741824) + " GB";
         if (bytes >= 1048576) return (bytes / 1048576) + " MB";
         if (bytes >= 1024) return (bytes / 1024) + " KB";
         return bytes + " bytes";
     }
 
     private class Item {
         public String file;
         public int icon;
         public boolean canRead;
 
         public Item(String file, Integer icon, boolean canRead) {
             this.file = file;
             this.icon = icon;
         }
 
         @Override
         public String toString() {
             return file;
         }
     }
 
     private class ItemFileNameComparator implements Comparator<Item> {
         public int compare(Item lhs, Item rhs) {
             return lhs.file.toLowerCase().compareTo(rhs.file.toLowerCase());
         }
     }
 }
 